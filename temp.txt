package com.example

import com.example.common.error.DomainValidationException
import com.example.common.error.ErrorResponse
import com.example.common.error.FieldError
import io.ktor.http.HttpStatusCode
import io.ktor.server.application.Application
import io.ktor.server.application.install
import io.ktor.server.plugins.callloging.CallLogging
import io.ktor.server.plugins.statuspages.StatusPages
import io.ktor.server.response.respond
import org.slf4j.event.Level
import org.valiktor.ConstraintViolationException

/**
 * 逶｣隕悶・萓句､悶ワ繝ｳ繝峨Μ繝ｳ繧ｰ繧偵∪縺ｨ繧√※險ｭ螳壹☆繧九・繝ｩ繧ｰ繧､繝ｳ縲・ */
fun Application.configureMonitoring() {

    install(CallLogging) {
        level = Level.INFO
    }

    install(StatusPages) {
        // Valiktor 縺ｮ讀懆ｨｼ繧ｨ繝ｩ繝ｼ繧貞・騾壹ヵ繧ｩ繝ｼ繝槭ャ繝医↓謨ｴ蠖｢
        exception<ConstraintViolationException> { call, cause ->
            val errors = cause.constraintViolations.map { violation ->
                FieldError(
                    field = violation.property,
                    code = violation.constraint.name,
                    message = violation.constraint.name
                )
            }
            call.respond(
                HttpStatusCode.BadRequest,
                ErrorResponse(
                    errorCode = "VALIDATION_ERROR",
                    message = "Validation failed",
                    errors = errors
                )
            )
        }

        // 繝峨Γ繧､繝ｳ蟆ら畑縺ｮ讀懆ｨｼ繧ｨ繝ｩ繝ｼ
        exception<DomainValidationException> { call, cause ->
            call.respond(
                HttpStatusCode.BadRequest,
                ErrorResponse(
                    errorCode = "DOMAIN_ERROR",
                    message = cause.message ?: "Domain validation failed",
                    errors = cause.violations
                )
            )
        }

        // 隱崎ｨｼ繝ｻ隱榊庄繝ｻ蟄伜惠縺励↑縺・Μ繧ｽ繝ｼ繧ｹ縺ｮ邨ｱ荳繝ｬ繧ｹ繝昴Φ繧ｹ
        status(HttpStatusCode.Unauthorized) { call, status ->
            call.respond(
                status,
                ErrorResponse(
                    errorCode = "UNAUTHORIZED",
                    message = "Authentication required"
                )
            )
        }
        status(HttpStatusCode.Forbidden) { call, status ->
            call.respond(
                status,
                ErrorResponse(
                    errorCode = "FORBIDDEN",
                    message = "Access is forbidden"
                )
            )
        }
        status(HttpStatusCode.NotFound) { call, status ->
            call.respond(
                status,
                ErrorResponse(
                    errorCode = "NOT_FOUND",
                    message = "Resource not found"
                )
            )
        }

        // 諠ｳ螳壼､悶・萓句､悶・ 500 縺ｨ縺励※繝ｭ繧ｰ縺ｫ谿九☆
        exception<Throwable> { call, cause ->
            call.application.environment.log.error("Unhandled server error", cause)
            call.respond(
                HttpStatusCode.InternalServerError,
                ErrorResponse(
                    errorCode = "INTERNAL_ERROR",
                    message = "Unexpected server error"
                )
            )
        }
    }
}
